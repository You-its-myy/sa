<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö°Ô∏è Jaika Sohbet (Tam ve √áalƒ±≈üan S√ºr√ºm)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> 
    
    <style>
        /* === GLOBAL STƒ∞LLER (≈ûIK GUI) === */
        :root {
            --bg-dark: #1e1f22; /* Ana Arka Plan */
            --bg-medium: #2b2d31; /* Orta Alan (Chat Alanƒ±) */
            --bg-light: #383a40; /* Giri≈ü/Kart Arka Planƒ± */
            --text-primary: #f2f3f5; /* Birincil Metin Rengi */
            --text-secondary: #b5bac1; /* ƒ∞kincil Metin/Zaman */
            --color-brand: #5865f2; /* Mavi Vurgu */
            --color-success: #23a55a; /* Ye≈üil (Ses/G√∂nder) */
            --color-danger: #f23f42; /* Kƒ±rmƒ±zƒ± (Sil/√áƒ±kƒ±≈ü) */
            --radius-default: 6px;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            transition: background-color 0.3s;
        }

        #app-container {
            width: 95%;
            max-width: 1400px;
            height: 95vh;
            display: flex;
            background-color: var(--bg-medium);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        /* === SOL PANEL (KANALLAR) === */
        #left-panel {
            width: 280px;
            background-color: var(--bg-dark);
            padding: 15px;
            border-right: 1px solid rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            flex-shrink: 0;
        }
        
        #site-name {
            color: var(--text-primary);
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-medium);
            width: 100%;
            text-align: center;
        }

        #site-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-size: cover;
            background-position: center;
            border: 4px solid var(--color-brand);
            margin-bottom: 20px;
        }

        #channels-container {
            width: 100%;
            padding: 0;
            flex-grow: 1; 
            overflow-y: auto;
        }
        
        #channels h3, #voice-channels h3 {
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 700;
            margin-top: 20px;
            margin-bottom: 8px;
            padding-left: 5px;
        }

        .channel-item, .voice-channel-item {
            padding: 8px 10px;
            border-radius: var(--radius-default);
            cursor: pointer;
            transition: background-color 0.15s, color 0.15s;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .channel-item:hover, .voice-channel-item:hover {
            background-color: var(--bg-light);
        }
        .channel-item.active {
            background-color: var(--color-brand);
            color: white;
        }
        .channel-item::before {
             content: '#';
             color: var(--text-secondary);
             font-size: 18px;
             margin-right: 5px;
             font-weight: 600;
        }
        .channel-item.active::before {
             color: white;
        }
        
        /* Sesli Kanallar */
        .voice-channel-item {
            color: var(--color-success); 
            flex-direction: column;
            align-items: flex-start;
        }
        .voice-channel-item::before {
            content: 'üîä'; 
            margin-right: 5px;
            font-size: 16px;
            color: var(--color-success);
            padding-right: 0;
        }
        .voice-user {
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 2px;
            padding-left: 0;
        }
        .voice-user::before {
            content: '‚Ä¢'; 
            margin-right: 5px;
            color: var(--color-success);
        }
        
        /* Butonlar */
        #create-channel-button, #join-voice-button, #end-call-button, #logout-button {
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius-default);
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background-color 0.2s, transform 0.1s;
            width: 100%;
            font-size: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        #create-channel-button { background-color: var(--color-brand); color: white; }
        #create-channel-button:hover { background-color: #4752c4; transform: translateY(-1px); }
        #join-voice-button { background-color: var(--color-success); color: white; }
        #join-voice-button:hover { background-color: #1e8749; transform: translateY(-1px); }
        #end-call-button { background-color: var(--color-danger); color: white; }
        #end-call-button:hover { background-color: #c43335; transform: translateY(-1px); }

        #logout-button {
            background-color: var(--bg-light);
            color: var(--text-secondary);
            margin-top: auto; 
            margin-bottom: 10px;
            box-shadow: none;
            border: 1px solid var(--bg-medium);
            width: calc(100% - 30px);
        }
        #logout-button:hover { background-color: #4b4d53; color: white; }
        
        #voice-status {
            margin-top: 15px;
            padding: 10px;
            background-color: var(--bg-light);
            border-radius: var(--radius-default);
            color: #ffc107; 
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
        }

        /* === SOHBET ALANI === */
        #chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        #channel-header {
            font-size: 24px;
            font-weight: 700;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--bg-light);
            color: var(--text-primary);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 15px;
            margin-bottom: 15px;
        }

        .message {
            display: flex;
            padding: 10px 0;
            margin-bottom: 5px; 
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .message:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .msg-avatar {
            width: 45px; 
            height: 45px;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #fff;
            font-size: 20px;
            background-color: var(--color-brand); 
            border: none;
        }
        .msg-avatar.has-photo {
             background-size: cover !important;
             background-position: center !important;
             text-indent: -9999px;
        }
        
        .msg-content { padding: 0; flex-grow: 1; }
        .msg-username { font-weight: bold; color: var(--text-primary); margin-right: 10px; font-size: 16px; }
        .msg-timestamp { color: var(--text-secondary); font-size: 12px; }
        .msg-text { word-wrap: break-word; font-size: 15px; line-height: 1.4; margin-top: 4px; }
        .msg-media { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
        .msg-image { max-height: 300px; object-fit: contain; }
        .msg-audio { width: 100%; max-width: 300px; margin-top: 5px; }

        /* === MESAJ Gƒ∞Rƒ∞≈û FORMU === */
        #message-form {
            display: flex;
            padding: 10px;
            background-color: var(--bg-light);
            border-radius: var(--radius-default);
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        #message-form #user-message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        #media-buttons { display: flex; align-items: center; margin-right: 10px; flex-shrink: 0; }
        #media-buttons button {
            background: none; border: none; color: var(--text-secondary); font-size: 24px; margin: 0 5px;
            cursor: pointer; padding: 5px; transition: color 0.2s, transform 0.1s;
        }
        #media-buttons button:hover { color: var(--color-brand); transform: scale(1.1); }
        
        #message-input {
            flex-grow: 1; padding: 10px; border: none; background: transparent; color: var(--text-primary);
            font-size: 16px; outline: none;
        }
        #message-input::placeholder { color: var(--text-secondary); opacity: 0.6; }

        #message-form button[type="submit"] {
            background-color: var(--color-brand); color: white; border: none; padding: 8px 12px;
            border-radius: var(--radius-default); cursor: pointer; font-weight: 600; margin-left: 10px;
            transition: background-color 0.2s; flex-shrink: 0;
        }
        #message-form button[type="submit"]:hover { background-color: #4752c4; }
        .editing-message { background-color: #5865f233; border-radius: 4px; padding: 0 5px; }
        #upload-status { color: var(--color-success); font-size: 14px; margin-left: 15px; margin-top: 5px; }

        /* === MODAL VE AUTH STƒ∞LLERƒ∞ === */
        #auth-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.85); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background-color: var(--bg-medium); padding: 40px; border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.6); width: 380px;
        }
        .auth-box h2 { color: var(--text-primary); margin-bottom: 30px; font-size: 28px; }
        .auth-box input[type="text"], .auth-box input[type="color"] {
            width: calc(100% - 22px); padding: 12px; margin-bottom: 20px; border: 1px solid var(--bg-light);
            background-color: var(--bg-dark); color: var(--text-primary); border-radius: var(--radius-default);
            outline: none; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .auth-box input[type="text"]:focus { border-color: var(--color-brand); box-shadow: 0 0 0 1px var(--color-brand); }
        .profile-photo-area { margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
        #profile-photo-preview {
            width: 90px; height: 90px; border-radius: 50%; background-color: var(--color-brand);
            margin-bottom: 10px; cursor: pointer; border: 3px solid var(--color-brand); transition: border-color 0.2s;
            display: flex; justify-content: center; align-items: center; font-size: 14px; color: white;
            background-size: cover; background-position: center;
        }

        /* === SAƒû TIK MEN√úS√ú === */
        #context-menu {
            background-color: var(--bg-light); border: none; border-radius: 8px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6); padding: 5px 0; position: absolute; z-index: 2000; display: none;
        }
        #context-menu div { padding: 10px 20px; font-size: 15px; cursor: pointer; transition: background-color 0.1s; }
        #context-menu div:hover { background-color: var(--bg-medium); }
        #context-menu .action-delete { color: var(--color-danger); }
        
        /* === SCROLLBAR === */
        #channels-container::-webkit-scrollbar, #messages::-webkit-scrollbar { width: 8px; background-color: transparent; }
        #channels-container::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb { background-color: var(--bg-light); border-radius: 4px; }
        #channels-container::-webkit-scrollbar-thumb:hover, #messages::-webkit-scrollbar-thumb:hover { background-color: #4b4d53; }
    </style>
</head>
<body>

    <div id="auth-modal" style="display: flex;">
        <div class="auth-box">
            <h2>Jaika'ya Ho≈ü Geldiniz!</h2>
            
            <div class="profile-photo-area">
                <div id="profile-photo-preview">PP Se√ß</div>
                <input type="file" id="profile-photo-input" style="display: none;" accept="image/*">
            </div>

            <input type="text" id="username-input" placeholder="Kullanƒ±cƒ± Adƒ±" maxlength="16">
            
            <div class="color-picker-container">
                <label for="avatar-color-input">Yedek Renk:</label>
                <input type="color" id="avatar-color-input" value="#5865f2">
            </div>

            <button id="signup-button">Kaydol ve Ba≈üla</button>
        </div>
    </div>
    
    <div id="context-menu">
        <div id="context-copy">Kopyala</div>
        <div id="context-edit">Mesajƒ± D√ºzenle</div>
        <div id="context-delete" class="action-delete">Sil</div>
    </div>

    <div id="app-container" style="display: none;">
        
        <div id="left-panel">
             <div id="site-name">Jaika</div>
            <div id="site-logo"></div>
            
            <button id="create-channel-button">+ Yeni Sohbet Olu≈ütur</button>

            <div id="channels-container">
                
                <div id="text-channels">
                    <h3>Metin Kanallarƒ±</h3>
                    <div id="channels">
                        </div>
                </div>

                <div id="voice-channels">
                    <h3>Ses Kanallarƒ±</h3>
                    <div class="voice-channel-item" data-id="ses-sohbet">
                        <span style="font-weight: 600;">#ses-sohbet</span>
                        <div id="voice-user-list" style="margin-top: 5px; padding-left: 10px;">
                            <span style="color: var(--text-secondary);">Kimse yok.</span>
                        </div>
                    </div>
                </div>

            </div>
            
            <div id="voice-status">Baƒülantƒ± Kapalƒ±</div>

            <button id="join-voice-button">Sesli Kanala Katƒ±l</button>
            <button id="end-call-button" style="display: none;">Aramayƒ± Sonlandƒ±r</button>

            <button id="logout-button">√áƒ±kƒ±≈ü Yap</button>
        </div>
        
        <audio id="remote-audio" autoplay></audio>

        <div id="chat-area">
             <div id="channel-header">#genel-sohbet</div>
            <div id="messages">
                </div>
            
            <form id="message-form">
                <div id="user-message-avatar" class="msg-avatar" style="background-color: #5865f2;"></div>
                <div id="media-buttons">
                    <button type="button" id="image-upload-button" title="Resim G√∂nder">üñºÔ∏è</button>
                    <button type="button" id="audio-record-button" title="Ses Kaydƒ± G√∂nder">üé§</button>
                </div>
                <input type="text" id="message-input" placeholder="Mesaj G√∂nderin" autocomplete="off">
                <button type="submit">G√∂nder</button>
            </form>
            
            <input type="file" id="media-file-input" style="display: none;" accept="image/*, audio/mp3, audio/wav, audio/webm">
            <div id="upload-status"></div>
            
            <input type="hidden" id="editing-message-key" value="">
        </div>

    </div>

    <script>
        // üî•üî•üî• D√úZELTƒ∞LMƒ∞≈û Firebase Yapƒ±landƒ±rmasƒ± üî•üî•üî•
        const firebaseConfig = {
            apiKey: "AIzaSyA49KR-d9hN6QXXcvZ68CfYLpMulad8p50",
            authDomain: "multiplayer-chat-552f7.firebaseapp.com",
            databaseURL: "https://multiplayer-chat-552f7-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "multiplayer-chat-552f7",
            messagingSenderId: "658594907764",
            appId: "1:658594907764:web:18ca661bd9dd9f504df321",
            measurementId: "G-9JMN9DMG82",
            // HATA √á√ñZ√úM√ú: storageBucket eklendi
            storageBucket: "multiplayer-chat-552f7.appspot.com" 
        };

        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage(); 
        const channelsRef = database.ref('channels'); 
        const usersRef = database.ref('users'); 
        const voiceSignalRef = database.ref('webrtc_signals/ses-sohbet'); 

        // DOM Elementleri
        const authModal = document.getElementById('auth-modal');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username-input');
        const avatarColorInput = document.getElementById('avatar-color-input');
        const signupButton = document.getElementById('signup-button');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('messages');
        const logoutButton = document.getElementById('logout-button');
        const joinVoiceButton = document.getElementById('join-voice-button');
        const endCallButton = document.getElementById('end-call-button');
        const voiceStatus = document.getElementById('voice-status');
        const voiceUserList = document.getElementById('voice-user-list');
        const imageUploadButton = document.getElementById('image-upload-button');
        const audioRecordButton = document.getElementById('audio-record-button');
        const mediaFileInput = document.getElementById('media-file-input');
        const uploadStatus = document.getElementById('upload-status');
        const userMessageAvatar = document.getElementById('user-message-avatar');
        const contextMenu = document.getElementById('context-menu');
        const editingMessageKeyInput = document.getElementById('editing-message-key');
        const profilePhotoInput = document.getElementById('profile-photo-input');
        const profilePhotoPreview = document.getElementById('profile-photo-preview');
        const channelHeader = document.getElementById('channel-header');
        const channelsDiv = document.getElementById('channels');

        // Durumlar
        let currentUser = null;
        let currentUserId = null;
        let activeChannelId = 'genel-sohbet'; 
        let activeMessagesRef = null;
        let profilePhotoFile = null;

        // WebRTC Durumlarƒ±
        let localStream = null; 
        let rtcConnection = null; 
        let targetUserId = null; 
        let mediaRecorder = null;
        let audioChunks = [];
        
        const iceServers = {
            'iceServers': [
                { 'urls': 'stun:stun.l.google.com:19302' },
                { 'urls': 'stun:stun1.l.google.com:19302' },
            ]
        };

        // --- Yardƒ±mcƒ± Fonksiyonlar ---
        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }
        
        function resetEditing() {
            editingMessageKeyInput.value = '';
            messageInput.placeholder = "Mesaj G√∂nderin";
            messageInput.value = '';
            messageInput.classList.remove('editing-message');
        }

        // --- WebRTC ve Sesli Sohbet Fonksiyonlarƒ± ---

        function initializeWebRTC() {
            rtcConnection = new RTCPeerConnection(iceServers);
            
            rtcConnection.onicecandidate = ({ candidate }) => {
                if (candidate) {
                    if (targetUserId) {
                        voiceSignalRef.child(targetUserId).child('ice').push({
                            senderId: currentUserId,
                            candidate: candidate
                        });
                    }
                }
            };

            rtcConnection.ontrack = (event) => {
                if (event.track.kind === 'audio') {
                    document.getElementById('remote-audio').srcObject = event.streams[0];
                    voiceStatus.textContent = "Ses Baƒülantƒ±sƒ± Aktif!";
                }
            };
            
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    rtcConnection.addTrack(track, localStream);
                });
            }
        }
        
        async function getMediaStream() {
            try {
                if (localStream) return localStream; 
                
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceStatus.textContent = "Mikrofon Aktif. Sesli Kanala Katƒ±lƒ±n.";
                return localStream;
            } catch (err) {
                console.error("Mikrofon eri≈üimi reddedildi:", err);
                voiceStatus.textContent = "Mikrofon izni reddedildi!";
                localStream = null;
                return null;
            }
        }
        
        async function startCall(remoteUserId, stream) {
            targetUserId = remoteUserId;
            voiceStatus.textContent = `Arama Yapƒ±lƒ±yor: ${remoteUserId.substring(0, 4)}...`;
            
            initializeWebRTC();

            const offer = await rtcConnection.createOffer();
            await rtcConnection.setLocalDescription(offer);

            voiceSignalRef.child(targetUserId).child('offers').push({
                senderId: currentUserId,
                offer: offer
            });
            
            joinVoiceButton.style.display = 'none';
            endCallButton.style.display = 'block';
        }

        async function handleOffer(senderId, offer) {
            targetUserId = senderId;
            voiceStatus.textContent = `Gelen Arama: ${senderId.substring(0, 4)}...`;
            
            const stream = await getMediaStream();
            if (!stream) return;
            
            initializeWebRTC();
            
            await rtcConnection.setRemoteDescription(new RTCSessionDescription(offer));

            const answer = await rtcConnection.createAnswer();
            await rtcConnection.setLocalDescription(answer);

            voiceSignalRef.child(senderId).child('answers').push({
                senderId: currentUserId,
                answer: answer
            });
            
            joinVoiceButton.style.display = 'none';
            endCallButton.style.display = 'block';
        }

        async function handleAnswer(answer) {
            if (rtcConnection && !rtcConnection.currentRemoteDescription) {
                await rtcConnection.setRemoteDescription(new RTCSessionDescription(answer));
                voiceStatus.textContent = `Baƒülantƒ± Kuruldu!`;
            }
        }

        function setupSignalListeners() {
            if (!currentUserId) return;
            
            voiceSignalRef.child(currentUserId).child('offers').on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.senderId !== currentUserId) {
                    handleOffer(data.senderId, data.offer);
                }
                snapshot.ref.remove();
            });
            
            voiceSignalRef.child(currentUserId).child('answers').on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (data.senderId !== currentUserId) {
                    handleAnswer(data.answer);
                }
                snapshot.ref.remove();
            });

            voiceSignalRef.child(currentUserId).child('ice').on('child_added', (snapshot) => {
                const data = snapshot.val();
                if (rtcConnection && data.candidate) {
                    rtcConnection.addIceCandidate(new RTCIceCandidate(data.candidate))
                        .catch(e => console.error("ICE aday hatasƒ±:", e));
                }
                snapshot.ref.remove();
            });
        }
        
        function endCall() {
            if (rtcConnection) { rtcConnection.close(); rtcConnection = null; }
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            
            document.getElementById('remote-audio').srcObject = null;
            targetUserId = null;
            
            if(currentUserId) {
                 voiceSignalRef.child(currentUserId).remove();
            }
            
            joinVoiceButton.style.display = 'block';
            endCallButton.style.display = 'none';
            voiceStatus.textContent = "Baƒülantƒ± Kapalƒ±";
        }
        
        // --- Kullanƒ±cƒ± Listesini G√ºncelleme (RTC i√ßin) ---
        function updateVoiceUserList() {
            voiceSignalRef.off('value'); 
            voiceSignalRef.on('value', (snapshot) => {
                voiceUserList.innerHTML = '';
                const usersInVoice = snapshot.val();
                let userCount = 0;

                if (usersInVoice) {
                    const userPromises = Object.keys(usersInVoice).map(userId => {
                        if (usersInVoice[userId].status === 'online') {
                            return usersRef.child(userId).once('value');
                        }
                        return null;
                    });

                    Promise.all(userPromises.filter(p => p !== null)).then(snapshots => {
                        voiceUserList.innerHTML = '';

                        snapshots.forEach(userSnap => {
                            const userData = userSnap.val();
                            if (userData) {
                                const userDiv = document.createElement('div');
                                userDiv.className = 'voice-user';
                                userDiv.textContent = userData.username; 

                                if (userSnap.key === currentUserId) {
                                     userDiv.textContent += " (Sen)";
                                }
                                
                                voiceUserList.appendChild(userDiv);
                                userCount++;
                            }
                        });

                        if (userCount === 0) {
                             voiceUserList.innerHTML = '<span style="color: var(--text-secondary);">Kimse yok.</span>';
                        }
                    });
                } else {
                    voiceUserList.innerHTML = '<span style="color: var(--text-secondary);">Kimse yok.</span>';
                }
            });
        }
        
        joinVoiceButton.addEventListener('click', async () => {
            if (rtcConnection) { voiceStatus.textContent = "Zaten baƒülƒ±sƒ±nƒ±z."; return; }
            
            const stream = await getMediaStream();
            if (!stream) return;

            voiceSignalRef.child(currentUserId).set({
                status: 'online',
                username: currentUser.username,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                voiceSignalRef.once('value', (snapshot) => {
                    const peers = snapshot.val();
                    let target = null;
                    
                    if (peers) {
                        for (const userId in peers) {
                            if (userId !== currentUserId && peers[userId].status === 'online') {
                                target = userId;
                                break; 
                            }
                        }
                    }

                    if (target) {
                        startCall(target, stream);
                    } else {
                        voiceStatus.textContent = "Kanalda kimse yok. Gelen aramayƒ± bekleyin.";
                        joinVoiceButton.style.display = 'none';
                        endCallButton.style.display = 'block'; 
                    }
                });
            });
        });
        endCallButton.addEventListener('click', endCall);


        // --- Kanal Y√∂netimi ---
        
        function switchChannel(channelId) {
            if (activeMessagesRef) { activeMessagesRef.off(); }
            messagesContainer.innerHTML = '';
            activeChannelId = channelId;
            channelHeader.textContent = '#' + channelId;
            activeMessagesRef = database.ref(`messages/${activeChannelId}`);
            loadMessages();
            
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.id === channelId) {
                    item.classList.add('active');
                }
            });
        }
        
        function loadChannels() {
            channelsRef.on('child_added', (snapshot) => {
                const channelId = snapshot.key;
                const channelDiv = document.createElement('div');
                channelDiv.className = 'channel-item';
                channelDiv.dataset.id = channelId;
                channelDiv.textContent = channelId;
                channelDiv.onclick = () => switchChannel(channelId);
                channelsDiv.appendChild(channelDiv);
                
                if (channelId === activeChannelId) {
                    channelDiv.classList.add('active');
                }
            });
        }
        
        document.getElementById('create-channel-button').addEventListener('click', () => {
            const newChannelId = prompt("Yeni kanal adƒ± (K√º√ß√ºk harf, bo≈üluksuz):");
            if (newChannelId && newChannelId.trim() !== '') {
                const normalizedId = newChannelId.trim().toLowerCase().replace(/\s/g, '-');
                channelsRef.child(normalizedId).set({ name: newChannelId }).then(() => {
                    switchChannel(normalizedId);
                });
            }
        });
        
        // --- Mesaj Y√∂netimi ve Medya ---
        
        function displayMessage(key, username, text, avatarColor, avatarInitial, avatarUrl, timestamp, mediaUrl = null, mediaType = null) {
            let messageDiv = document.querySelector(`.message[data-key="${key}"]`);
            const isNew = !messageDiv;

            if (isNew) {
                messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.dataset.key = key;
                messageDiv.addEventListener('contextmenu', (e) => showContextMenu(e, key, text));
            }
            
            const date = new Date(timestamp);
            const timeString = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

            if (isNew) {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'msg-avatar';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'msg-content';
                const headerDiv = document.createElement('div');
                headerDiv.innerHTML = `<span class="msg-username">${username}</span> <span class="msg-timestamp">${timeString}</span>`;

                contentDiv.appendChild(headerDiv);
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(contentDiv);
            }

            const avatarDiv = messageDiv.querySelector('.msg-avatar');
            const contentDiv = messageDiv.querySelector('.msg-content');
            
            // Avatarƒ± G√ºncelle
            if (avatarUrl) {
                avatarDiv.style.backgroundImage = `url('${avatarUrl}')`;
                avatarDiv.classList.add('has-photo');
                avatarDiv.style.backgroundColor = 'transparent';
                avatarDiv.textContent = '';
            } else {
                avatarDiv.style.backgroundImage = 'none';
                avatarDiv.classList.remove('has-photo');
                avatarDiv.style.backgroundColor = avatarColor || '#7289da'; 
                avatarDiv.textContent = avatarInitial || username.charAt(0).toUpperCase();
            }

            // ƒ∞√ßeriƒüi G√ºncelle
            let textP = messageDiv.querySelector('.msg-text');
            if (textP) textP.remove();
            let mediaElement = messageDiv.querySelector('.msg-media');
            if (mediaElement) mediaElement.remove();

            if (mediaUrl && mediaType) {
                if (mediaType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = mediaUrl;
                    img.className = 'msg-media msg-image';
                    contentDiv.appendChild(img);
                } else if (mediaType.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.src = mediaUrl;
                    audio.controls = true;
                    audio.className = 'msg-media msg-audio';
                    contentDiv.appendChild(audio);
                }
            }

            if (text) {
                textP = document.createElement('p');
                textP.className = 'msg-text';
                textP.textContent = text;
                contentDiv.appendChild(textP);
            }
            
            if (isNew) {
                messagesContainer.appendChild(messageDiv);
                scrollToBottom();
            }
        }
        
        function loadMessages() {
            if (!activeMessagesRef) return;
            
            activeMessagesRef.on('child_added', (snapshot) => {
                const message = snapshot.val();
                usersRef.child(message.userId).once('value').then(userSnap => {
                    const userData = userSnap.val() || {};
                    displayMessage(snapshot.key, userData.username || message.username, message.text, 
                                   userData.avatarColor || message.avatarColor, userData.avatarInitial || message.avatarInitial, 
                                   userData.photoUrl || null, message.timestamp, message.mediaUrl, message.mediaType);
                });
            });
            
            activeMessagesRef.on('child_changed', (snapshot) => {
                const message = snapshot.val();
                usersRef.child(message.userId).once('value').then(userSnap => {
                    const userData = userSnap.val() || {};
                    displayMessage(snapshot.key, userData.username || message.username, message.text, 
                                   userData.avatarColor || message.avatarColor, userData.avatarInitial || message.avatarInitial, 
                                   userData.photoUrl || null, message.timestamp, message.mediaUrl, message.mediaType);
                });
            });
            
            activeMessagesRef.on('child_removed', (snapshot) => {
                const messageElement = document.querySelector(`.message[data-key="${snapshot.key}"]`);
                if(messageElement) { messageElement.remove(); }
            });
        }
        
        function sendMessage(text, mediaUrl = null, mediaType = null) {
            if (!activeMessagesRef) return;
            
            const newMessage = {
                userId: currentUserId,
                username: currentUser.username,
                text: text || '',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                avatarColor: currentUser.avatarColor,
                avatarInitial: currentUser.avatarInitial,
                mediaUrl: mediaUrl,
                mediaType: mediaType
            };

            activeMessagesRef.push(newMessage).then(() => {
                messageInput.value = '';
                uploadStatus.textContent = '';
                mediaFileInput.value = ''; // Media input'u temizle
                scrollToBottom();
            }).catch(error => {
                console.error("Mesaj g√∂nderme hatasƒ±:", error);
                uploadStatus.textContent = "G√∂nderme Ba≈üarƒ±sƒ±z!";
            });
        }
        
        // --- Medya Y√ºkleme ---
        
        imageUploadButton.addEventListener('click', () => { mediaFileInput.accept = 'image/*'; mediaFileInput.click(); });
        mediaFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) { uploadMedia(file); }
        });

        async function uploadMedia(file) {
            uploadStatus.textContent = "Y√ºkleniyor... (0%)";
            
            const filePath = `chat_media/${activeChannelId}/${currentUserId}/${Date.now()}_${file.name || 'audio_record.webm'}`;
            const storageRef = storage.ref().child(filePath);
            const uploadTask = storageRef.put(file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadStatus.textContent = `Y√ºkleniyor... (${Math.round(progress)}%)`;
                }, 
                (error) => {
                    console.error("Y√ºkleme hatasƒ±:", error);
                    uploadStatus.textContent = "Y√ºkleme Ba≈üarƒ±sƒ±z!";
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        const messageText = messageInput.value.trim() || `[${file.type.split('/')[0].toUpperCase()} Eklendi]`;
                        sendMessage(messageText, downloadURL, file.type);
                        mediaFileInput.value = '';
                    });
                }
            );
        }
        
        // --- Ses Kaydƒ± ---
        audioRecordButton.addEventListener('click', () => {
            if (!mediaRecorder) {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (e) => { audioChunks.push(e.data); };
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        audioChunks = [];
                        uploadMedia(audioBlob); 
                    };
                    mediaRecorder.start();
                    audioRecordButton.textContent = '‚èπÔ∏è';
                    uploadStatus.textContent = 'Kayƒ±t Ba≈üladƒ±...';
                }).catch(err => {
                    alert('Mikrofon eri≈üimi gerekli: ' + err.message);
                });
            } else if (mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                audioRecordButton.textContent = 'üé§';
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                mediaRecorder = null;
                uploadStatus.textContent = '';
            }
        });

        // --- Saƒü Tƒ±k Men√ºs√º (Context Menu) ---

        function showContextMenu(e, messageKey, messageText) {
            e.preventDefault(); 
            contextMenu.style.top = `${e.clientY}px`;
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.dataset.key = messageKey;
            contextMenu.dataset.text = messageText;
            contextMenu.style.display = 'block';
        }

        document.addEventListener('click', () => { contextMenu.style.display = 'none'; });

        document.getElementById('context-copy').addEventListener('click', () => {
            const textToCopy = contextMenu.dataset.text;
            if (textToCopy) { navigator.clipboard.writeText(textToCopy); }
            contextMenu.style.display = 'none';
        });
        
        document.getElementById('context-edit').addEventListener('click', () => {
            const key = contextMenu.dataset.key;
            const text = contextMenu.dataset.text;
            
            if (key && currentUserId) {
                messageInput.value = text;
                messageInput.placeholder = "Mesaj D√ºzenleniyor...";
                messageInput.classList.add('editing-message');
                editingMessageKeyInput.value = key;
                contextMenu.style.display = 'none';
                messageInput.focus();
            }
        });
        
        document.getElementById('context-delete').addEventListener('click', () => {
            const key = contextMenu.dataset.key;
            if (confirm("Bu mesajƒ± silmek istediƒüinizden emin misiniz?")) {
                if (key && activeMessagesRef) { activeMessagesRef.child(key).remove(); }
            }
            contextMenu.style.display = 'none';
        });

        // --- Mesaj G√∂nderme (Submit) ---
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            const editingKey = editingMessageKeyInput.value;

            if (editingKey) {
                if (text) {
                    activeMessagesRef.child(editingKey).update({
                        text: text,
                        edited: true,
                        editedAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        resetEditing();
                    });
                } else {
                    alert("L√ºtfen bir d√ºzenleme metni girin veya d√ºzenlemeyi iptal edin.");
                }
            } else if (text || mediaFileInput.files.length > 0) {
                 if (mediaFileInput.files.length > 0) {
                     uploadMedia(mediaFileInput.files[0]);
                 } else {
                    sendMessage(text);
                 }
            }
        });
        
        // --- Auth ve Profil Y√∂netimi ---

        profilePhotoPreview.addEventListener('click', () => { profilePhotoInput.click(); });
        profilePhotoInput.addEventListener('change', (e) => {
            profilePhotoFile = e.target.files[0];
            if (profilePhotoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    profilePhotoPreview.style.backgroundImage = `url('${e.target.result}')`;
                    profilePhotoPreview.textContent = '';
                };
                reader.readAsDataURL(profilePhotoFile);
            }
        });

        async function uploadProfilePhoto(userId, file) {
            const storageRef = storage.ref().child(`avatars/${userId}.jpg`);
            const snapshot = await storageRef.put(file);
            return snapshot.ref.getDownloadURL();
        }

        signupButton.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            const avatarColor = avatarColorInput.value;

            if (!username) { alert("L√ºtfen bir kullanƒ±cƒ± adƒ± girin."); return; }
            signupButton.disabled = true;

            try {
                let userCredential = await auth.signInAnonymously();
                const userId = userCredential.user.uid;
                
                let photoUrl = null;
                if (profilePhotoFile) { photoUrl = await uploadProfilePhoto(userId, profilePhotoFile); }
                
                await usersRef.child(userId).set({
                    username: username,
                    avatarColor: avatarColor,
                    avatarInitial: username.charAt(0).toUpperCase(),
                    photoUrl: photoUrl
                });

            } catch (error) {
                console.error("Kayƒ±t/Giri≈ü Hatasƒ±:", error);
                alert("Kayƒ±t/Giri≈ü sƒ±rasƒ±nda bir hata olu≈ütu: " + error.message);
            } finally {
                signupButton.disabled = false;
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            try {
                endCall(); 
                if (currentUserId) { voiceSignalRef.child(currentUserId).remove(); }
                await auth.signOut();
            } catch (error) {
                console.error("√áƒ±kƒ±≈ü Hatasƒ±:", error);
            }
        });

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                const userSnapshot = await usersRef.child(currentUserId).once('value');
                currentUser = userSnapshot.val();

                if (currentUser && currentUser.username) {
                    authModal.style.display = 'none'; 
                    appContainer.style.display = 'flex'; 
                    
                    // Avatarƒ± g√ºncelle
                    const avatarElement = document.getElementById('user-message-avatar');
                    if (currentUser.photoUrl) {
                        avatarElement.style.backgroundImage = `url('${currentUser.photoUrl}')`;
                        avatarElement.classList.add('has-photo');
                        avatarElement.textContent = '';
                    } else {
                        avatarElement.style.backgroundColor = currentUser.avatarColor;
                        avatarElement.textContent = currentUser.avatarInitial;
                        avatarElement.classList.remove('has-photo');
                    }
                    
                    loadChannels();
                    switchChannel(activeChannelId); 
                    setupSignalListeners();
                    updateVoiceUserList(); 
                    
                } else {
                    authModal.style.display = 'flex';
                    appContainer.style.display = 'none';
                }

            } else {
                if (activeMessagesRef) { activeMessagesRef.off(); }
                voiceSignalRef.off();
                endCall(); 
                
                currentUser = null;
                currentUserId = null;
                
                appContainer.style.display = 'none'; 
                authModal.style.display = 'flex'; 
                messagesContainer.innerHTML = ''; 
                channelsDiv.innerHTML = '';
            }
        });
    </script>
</body>
</html>
